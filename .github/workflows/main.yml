name: Deploy to SharePoint On-Prem

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

  deploy:
    needs: build
    runs-on: windows-latest
    name: Copy layout files to db-sp

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "❌ Missing secret: SSH_HOST"
            exit 1
          fi

          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "❌ Missing secret: SSH_USER"
            exit 1
          fi

          if [ -z "${{ secrets.SSH_PASSWORD }}" ]; then
            echo "❌ Missing secret: SSH_PASSWORD"
            exit 1
          fi

          echo "✅ All required secrets are set."

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "Mapping UNC path..."

            net use Z: "\\db-sp.darbeirut.com\LAYOUTS\PCW\CICD" /user:${{ secrets.SSH_USER }} ${{ secrets.SSH_PASSWORD }}

            echo "Copying files to UNC share..."

            xcopy /E /Y "C:\Temp\build\*" "Z:\"

            echo "Deployment complete."

            net use Z: /delete
